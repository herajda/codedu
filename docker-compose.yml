version: "3.8"

services:
  proxy:
    image: nginx:1.27-alpine
    depends_on:
      - frontend
      - backend
    ports:
      - "${APP_PORT:-61189}:80"
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/conf.d/default.conf:ro,z
    networks: [appnet]

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      ORIGIN: http://localhost:${APP_PORT:-61189}
      PUBLIC_API_BASE: /api
      SSR_API_BASE: http://backend:${BACKEND_PORT:-8080}
      PASSWORD_RESET_BASE_URL: https://localhost:${APP_PORT:-61189}
    env_file:
      - .env
    depends_on:
      - backend
    volumes:
      - ./.env:/app/.env:ro
    networks: [appnet]

  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    environment:
      PORT: "${BACKEND_PORT:-8080}"
      DATABASE_URL: postgres://${DB_USER:-codedu_user}:${DB_PASSWORD:-supersecret}@${DB_HOST:-db}:${DB_PORT:-5432}/${DB_NAME:-codedu_db}?sslmode=${DB_SSLMODE:-disable}
      PASSWORD_RESET_BASE_URL: https://localhost:${APP_PORT:-61189}
      DB_HOST: "${DB_HOST:-db}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_USER: "${DB_USER:-codedu_user}"
      DB_PASSWORD: "${DB_PASSWORD:-supersecret}"
      DB_NAME: "${DB_NAME:-codedu_db}"
      DB_SSLMODE: "${DB_SSLMODE:-disable}"
      EXECUTION_ROOT: /sandbox
      PYTHON_RUNNER_IMAGE: python:3.11
      DOCKER_HOST: tcp://docker-engine:2375
      DOCKER_TLS_CERTDIR: ""
      DOCKER_USER: "65534:65534"
      DOCKER_CPUS: "0.5"
      DOCKER_MEMORY: "256m"
      GIN_MODE: release
      QEMU_VNC_PORT: "${QEMU_VNC_PORT:-5900}"
      QEMU_VNC_BIND: "${QEMU_VNC_BIND:-0.0.0.0}"
    env_file:
      - .env
    depends_on:
      docker-engine:
        condition: service_started
    devices:
      - /dev/kvm:/dev/kvm
    volumes:
      - runner_shared:/sandbox:z
      - ./.env:/app/.env:ro
    networks: [appnet]

  docker-engine:
    image: docker:27-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    # Use the image's default entrypoint (dockerd-entrypoint.sh) so it can
    # properly prepare cgroups for DinD on cgroup v2 hosts.
    command: ["--host=tcp://0.0.0.0:2375","--storage-driver=overlay2","--iptables=false","--ip-masq=false","--log-level=error"]
    volumes:
      - docker_data:/var/lib/docker
      - runner_shared:/sandbox:z
    networks: [appnet]

  db-backup:
    image: postgres:16-alpine
    restart: unless-stopped
    user: "0:0"
    environment:
      POSTGRES_HOST: "${DB_HOST:-db}"
      POSTGRES_PORT: "${DB_PORT:-5432}"
      POSTGRES_DB: "${DB_NAME:-codedu_db}"
      POSTGRES_USER: "${DB_USER:-codedu_user}"
      POSTGRES_PASSWORD: "${DB_PASSWORD:-supersecret}"
      LOCAL_BACKUP_DIR: /backups/local
      RETENTION_DAYS: "7"
    volumes:
      - ./deploy/backup/run_backup.sh:/opt/run_backup.sh:ro,z
      - ./deploy/backup/entrypoint.sh:/opt/entrypoint.sh:ro,z
      - ./backups/local:/backups/local:rw,z
    entrypoint: ["/bin/sh","/opt/entrypoint.sh"]
    networks: [appnet]


volumes:
  docker_data:
  runner_shared:

networks:
  appnet:
